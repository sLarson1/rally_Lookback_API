<!DOCTYPE html>
<html>
<head>
    <title>SeanLookback</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){var isDate=function(date){return"[object Date]"===Object.prototype.toString.call(date)?(Ext.global.console.log("Looks like a date:",date),isNaN(date.getTime())?(Ext.global.console.log("But not a good date format, returning false"),!1):(Ext.global.console.log("And is a valid date format"),!0)):(Ext.global.console.log("NOT A DATE!",date),!1)},getBusinessDays=function(_startDate,_endDate){var startDate=new Date(Date.parse(_startDate)),endDate=new Date(Date.parse(_endDate)),businessDaysTotal=-1;if(isDate(startDate)&&isDate(endDate)){var leadingSaturday=6,calendarDays=(endDate-startDate)/864e5,startDay=startDate.getDay(),endDay=endDate.getDay(),numberOfLeadingDays=leadingSaturday-startDay,numberOfTrailingDays=endDay,elapsedDaysBlock=calendarDays-numberOfLeadingDays-numberOfTrailingDays,calendarWeeks=Math.floor(elapsedDaysBlock/7),businessDays=5*calendarWeeks;businessDaysTotal=businessDays+numberOfLeadingDays+numberOfTrailingDays}else Ext.global.console.log("Not valid dates:"+startDate+" , "+endDate);return businessDaysTotal},date1=new Date(2017,4,28),date2=new Date(2017,5,8);getBusinessDays(date1,date2),Ext.create("Rally.data.lookback.SnapshotStore",{context:{workspace:"/workspace/15956831576"},find:{ObjectID:86637102004},sort:{_UnformattedID:1},fetch:["FormattedID","c_WorkItemStatus","Name"]}).load({callback:function(records){Ext.global.console.log("Record!",records[0].data.FormattedID+", "+records[0].data.c_WorkItemStatus),Ext.global.console.log("Records Retrieved!",records);var majorVersion;majorVersion=void 0!==Ext.version?Ext.version:Ext.getVersion();var webWorkerSupport;webWorkerSupport="undefined"!=typeof Worker?"Web Workers ARE Supported.":"Web Workers NOT available.";var todo=records[0].data.FormattedID+" "+records[0].data.Name+"<BR>&nbsp;&nbsp; ExtJS Version:"+majorVersion+"<BR>&nbsp;&nbsp;Webworker Support:"+webWorkerSupport+"<BR><BR>Add businessDays() function into app.<BR>Look at issue with Peer Review not showing up....Also how do we account of the work status moves forward and then moves back???<BR>  Look at commented out function in this app.js file  Then implement elapsed business days:http://stackoverflow.com/questions/3464268/find-day-difference-between-two-dates-excluding-weekend-days<BR><BR><BR>",str="",myfunc=function(element,index){var dayFrom=new Date(records[index].data._ValidFrom),dayTo=new Date(records[index].data._ValidTo);str+=records[index].data.FormattedID+", "+records[index].data.c_WorkItemStatus+", "+dayFrom.toDateString()+":"+dayFrom.toTimeString()+",  "+dayTo.toDateString()+":"+dayTo.toTimeString()+"<BR>"};records.forEach(myfunc);var filter=function(records){for(var filteredRecs=[],numberFilteredOut=0,i=0;i<records.length;i++){var record=records[i].data.FormattedID+", "+records[i].data.c_WorkItemStatus+", "+records[i].data._ValidFrom.substr(0,records[i].data._ValidFrom.indexOf("T"))+", "+records[i].data._ValidTo.substr(0,records[i].data._ValidTo.indexOf("T"));if(i>0){var previousRecord=records[i-1].data.FormattedID+", "+records[i].data.c_WorkItemStatus+", "+records[i-1].data._ValidFrom.substr(0,records[i-1].data._ValidFrom.indexOf("T"))+", "+records[i-1].data._ValidTo.substr(0,records[i-1].data._ValidTo.indexOf("T"));if(record!==previousRecord){var lastRec=filteredRecs[filteredRecs.length-1].data,proposedRec=records[i].data;if(lastRec.FormattedID===proposedRec.FormattedID&&lastRec.c_WorkItemStatus===proposedRec.c_WorkItemStatus&&lastRec._ValidTo.substr(0,lastRec._ValidTo.indexOf("T"))===proposedRec._ValidFrom.substr(0,proposedRec._ValidFrom.indexOf("T"))){Ext.global.console.log("ARE EQUAL!! - "+lastRec.FormattedID+"=="+proposedRec.FormattedID+lastRec.c_WorkItemStatus+"=="+proposedRec.c_WorkItemStatus+lastRec._ValidTo.substr(0,lastRec._ValidTo.indexOf("T"))+"=="+proposedRec._ValidFrom.substr(0,proposedRec._ValidFrom.indexOf("T")));var updateRecord=filteredRecs.pop();Ext.global.console.log("OLD Record:",updateRecord),Ext.global.console.log("updateRecord.data._ValidTo:"+updateRecord.data._ValidTo+" << proposedRec._ValidTo:"+proposedRec._ValidTo),updateRecord.data._ValidTo=proposedRec._ValidTo,Ext.global.console.log("UPDATED updateRecord.data._ValidTo:"+updateRecord.data._ValidTo+" << proposedRec._ValidTo:"+proposedRec._ValidTo),updateRecord.elapsedBusinessDays=getBusinessDays(updateRecord._ValidFrom,updateRecord._ValidTo),Ext.global.console.log("Pushing UPDATED Record:",updateRecord),filteredRecs.push(updateRecord)}else Ext.global.console.log("previousRecord:"+previousRecord+" and record:"+record+"are different. pushing:"+record),Ext.global.console.log("NOT EQUAL"+lastRec.FormattedID+"=="+proposedRec.FormattedID+lastRec.c_WorkItemStatus+"=="+proposedRec.c_WorkItemStatus+lastRec._ValidTo+"=="+proposedRec._ValidTo),records[i].elapsedBusinessDays=getBusinessDays(records[i]._ValidFrom,records[i]._ValidTo),filteredRecs.push(records[i])}else numberFilteredOut+=1,Ext.global.console.log(record+" and "+previousRecord+" are the same.  Skipping:str"+record+" total filtered:"+numberFilteredOut)}else records[i].elapsedBusinessDays=getBusinessDays(records[i]._ValidFrom,records[i]._ValidTo),Ext.global.console.log("i="+i+"pushing:"+record),filteredRecs.push(records[i])}Ext.global.console.log("Filtered Recs:",filteredRecs);for(var i=0;i<filteredRecs.length;i++){var dayFrom=new Date(filteredRecs[i].data._ValidFrom),dayTo=new Date(filteredRecs[i].data._ValidTo);Ext.global.console.log("Filtered Record:"+filteredRecs[i].data.FormattedID+", "+filteredRecs[i].data.c_WorkItemStatus+", "+dayFrom.toDateString()+":"+dayFrom.toTimeString()+",  "+dayTo.toDateString()+":"+dayTo.toTimeString())}return filteredRecs},childPanel1=Ext.create("Ext.panel.Panel",{title:"Todo - 'C:\\tmp\\scripts\\rally_Lookback_API'",autoScroll:!0,html:todo}),childPanel2=Ext.create("Ext.panel.Panel",{title:"Story Aging Report",autoScroll:!0,html:str}),childPanel3=Ext.create("Ext.panel.Panel",{title:"Filtered Records",autoScroll:!0,html:filter(records)});Ext.create("Ext.container.Viewport",{items:[childPanel1,childPanel3,childPanel2]})},scope:this})}});

            Rally.launchApp('CustomApp', {
                name:"SeanLookback",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
